"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,n,o){o===void 0&&(o=n);var r=Object.getOwnPropertyDescriptor(e,n);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,o,r)}:function(t,e,n,o){o===void 0&&(o=n),t[o]=e[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(){var t=function(e){return t=Object.getOwnPropertyNames||function(n){var o=[];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(o[o.length]=r);return o},t(e)};return function(e){if(e&&e.__esModule)return e;var n={};if(e!=null)for(var o=t(e),r=0;r<o.length;r++)o[r]!=="default"&&__createBinding(n,e,o[r]);return __setModuleDefault(n,e),n}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.activate=activate,exports.deactivate=deactivate;const fs=__importStar(require("fs")),path=__importStar(require("path")),vscode=__importStar(require("vscode"));function activate(t){const e=vscode.window.createOutputChannel("New Db Viewer");e.appendLine("Activated");const n=String(t.extension.packageJSON.version??""),o=String(t.extension.packageJSON.displayName??t.extension.packageJSON.name??"New Db Viewer"),r=new DbViewerCustomEditorProvider(t.extensionUri,e,o,n),l=vscode.window.registerCustomEditorProvider("newDbViewer.dbViewer",r,{supportsMultipleEditorsPerDocument:!0}),h=vscode.commands.registerCommand("newDbViewer.open",async()=>{const s=await pickDatabaseFile();s&&await openWithViewer(s,e)}),y=vscode.commands.registerCommand("newDbViewer.openFile",async s=>{const i=s??await pickDatabaseFile();i&&await openWithViewer(i,e)}),f=vscode.workspace.onDidOpenTextDocument(async s=>{isDatabaseFile(s.uri)&&await openWithViewer(s.uri,e)});t.subscriptions.push(l,h,y,f,e)}function deactivate(){}async function pickDatabaseFile(){const t=await vscode.window.showOpenDialog({canSelectMany:!1,filters:{SQLite:["db","sqlite","sqlite3"]}});return t==null?void 0:t[0]}class DbViewerDocument{constructor(e){this.uri=e}dispose(){}}class DbViewerCustomEditorProvider{constructor(e,n,o,r){this.extensionUri=e,this.output=n,this.extensionDisplayName=o,this.extensionVersion=r}async openCustomDocument(e){return this.output.appendLine(`openCustomDocument: ${e.fsPath}`),new DbViewerDocument(e)}async resolveCustomEditor(e,n){this.output.appendLine(`resolveCustomEditor: ${e.uri.fsPath}`),n.webview.options={enableScripts:!0,localResourceRoots:[vscode.Uri.joinPath(this.extensionUri,"webview-ui","dist"),vscode.Uri.joinPath(this.extensionUri,"dist","codicons")]};let o=!1,r,l=!1;const h=path.basename(e.uri.fsPath),y=()=>{l||(l=!0,n.webview.postMessage({type:"webview:config",displayName:this.extensionDisplayName,version:this.extensionVersion}))},f=async()=>(r=await vscode.workspace.fs.readFile(e.uri),this.output.appendLine(`read db bytes: ${r.byteLength}`),r),s=async()=>{r||await f(),r&&o&&(this.output.appendLine(`sending db bytes: ${r.byteLength}`),n.webview.postMessage({type:"db:load",name:h,bytes:r}))};n.webview.onDidReceiveMessage(i=>{if((i==null?void 0:i.type)==="webview:ready"){this.output.appendLine("webview:ready"),o=!0,y(),s();return}if((i==null?void 0:i.type)==="webview:refresh"){this.output.appendLine("webview:refresh"),f().then(()=>s());return}if((i==null?void 0:i.type)==="db:save"){const a=normalizeMessageBytes(i.bytes),u=i.saveId;if(this.output.appendLine(`db:save received bytes=${a?a.byteLength:"invalid"}`),!a){const c="db:save received invalid bytes";this.output.appendLine(c),n.webview.postMessage({type:"db:save:result",ok:!1,message:c,saveId:u});return}vscode.workspace.fs.writeFile(e.uri,a).then(()=>{r=a,this.output.appendLine(`db saved: ${e.uri.fsPath}`),n.webview.postMessage({type:"db:save:result",ok:!0,message:"Saved",saveId:u})},c=>{const d=c instanceof Error?c.message:String(c);this.output.appendLine(`db save failed: ${d}`),n.webview.postMessage({type:"db:save:result",ok:!1,message:d,saveId:u})});return}if((i==null?void 0:i.type)==="export:file"){const a=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",u=typeof i.text=="string"?i.text:"";if(!u){n.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}const c=path.extname(a).replace(".","")||"txt",d=path.dirname(e.uri.fsPath),w=vscode.Uri.file(path.join(d,a));(async()=>{const p=await vscode.window.showSaveDialog({defaultUri:w,filters:{[c.toUpperCase()]:[c]}});if(!p){n.webview.postMessage({type:"export:result",ok:!1,message:"Save canceled."});return}await vscode.workspace.fs.writeFile(p,Buffer.from(u,"utf8")),n.webview.postMessage({type:"export:result",ok:!0,message:`Saved ${path.basename(p.fsPath)}`})})().catch(p=>{const v=p instanceof Error?p.message:String(p);n.webview.postMessage({type:"export:result",ok:!1,message:v})});return}if((i==null?void 0:i.type)==="export:save"){const a=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",u=typeof i.text=="string"?i.text:"";if(!u){n.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}const c=path.dirname(e.uri.fsPath),d=path.join(c,a);vscode.workspace.fs.writeFile(vscode.Uri.file(d),Buffer.from(u,"utf8")).then(()=>{this.output.appendLine(`saved export: ${d}`),n.webview.postMessage({type:"export:result",ok:!0,message:`Saved to ${d}`})},w=>{const p=w instanceof Error?w.message:String(w);n.webview.postMessage({type:"export:result",ok:!1,message:p})});return}if((i==null?void 0:i.type)==="webview:log"){i.message&&this.output.appendLine(`webview log: ${i.message}`);return}if((i==null?void 0:i.type)==="webview:error"){const a=[i.message?`message=${i.message}`:void 0,i.source?`source=${i.source}`:void 0,i.line?`line=${i.line}`:void 0,i.column?`column=${i.column}`:void 0].filter(Boolean).join(" ");this.output.appendLine(`webview error: ${a}`),i.stack&&this.output.appendLine(String(i.stack))}}),await f(),n.webview.html=getWebviewHtml(n.webview,this.extensionUri),o&&await s()}}async function openWithViewer(t,e){if(!isDatabaseFile(t))return;const n=t.toString();if(!openGate.has(n)){openGate.add(n),setTimeout(()=>openGate.delete(n),1500);try{await vscode.commands.executeCommand("vscode.openWith",t,"newDbViewer.dbViewer")}catch(o){const r=o instanceof Error?o.message:String(o);e.appendLine(`openWith failed: ${r}`),vscode.window.showErrorMessage(`New Db Viewer could not be opened: ${r}`)}}}const openGate=new Set;function isDatabaseFile(t){const e=path.extname(t.fsPath).toLowerCase();return e===".db"||e===".sqlite"||e===".sqlite3"}function getWebviewHtml(t,e){const n=vscode.Uri.joinPath(e,"webview-ui","dist"),o=vscode.Uri.joinPath(n,"index.html");let r=fs.readFileSync(o.fsPath,"utf8");const l=Date.now().toString(),h=getNonce(),y=["default-src 'none'",`img-src ${t.cspSource} blob: data:`,`style-src ${t.cspSource} 'unsafe-inline'`,`font-src ${t.cspSource}`,`connect-src ${t.cspSource}`,`worker-src ${t.cspSource}`,`script-src 'nonce-${h}' 'wasm-unsafe-eval'`].join("; "),f=t.asWebviewUri(vscode.Uri.joinPath(e,"dist","codicons","codicon.css"));r=r.replace("<head>",`<head>
<meta http-equiv="Content-Security-Policy" content="${y}">
<link rel="stylesheet" href="${f}">`);const s=t.asWebviewUri(n).toString();return r=r.replace(/(href|src)=\"\.\/?assets\//g,`$1="${s}/assets/`),r=r.replace(/(href|src)=\"\/assets\//g,`$1="${s}/assets/`),r=r.replace(/assets\/[^\"']+\.(?:js|css|wasm)/g,i=>`${i}?v=${l}`),r=r.replace(/<script /g,`<script nonce="${h}" `),r}function getNonce(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let n=0;n<32;n+=1)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function normalizeMessageBytes(t){if(t instanceof Uint8Array)return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(Array.isArray(t))return Uint8Array.from(t);if(t&&typeof t=="object"){const e=t;if(e.type==="Buffer"&&Array.isArray(e.data)||Array.isArray(e.data))return Uint8Array.from(e.data);const n=Object.values(e);if(n.length&&n.every(o=>typeof o=="number"))return Uint8Array.from(n)}}
