"use strict";var _=exports&&exports.__createBinding||(Object.create?function(o,t,e,r){r===void 0&&(r=e);var n=Object.getOwnPropertyDescriptor(t,e);(!n||("get"in n?!t.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(o,r,n)}:function(o,t,e,r){r===void 0&&(r=e),o[r]=t[e]}),A=exports&&exports.__setModuleDefault||(Object.create?function(o,t){Object.defineProperty(o,"default",{enumerable:!0,value:t})}:function(o,t){o.default=t}),x=exports&&exports.__importStar||function(){var o=function(t){return o=Object.getOwnPropertyNames||function(e){var r=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[r.length]=n);return r},o(t)};return function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r=o(t),n=0;n<r.length;n++)r[n]!=="default"&&_(e,t,r[n]);return A(e,t),e}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.activate=E;exports.deactivate=O;var j=x(require("fs")),b=x(require("path")),a=x(require("vscode"));function E(o){let t=a.window.createOutputChannel("SQLite DB Viewer");t.appendLine("Activated");let e=String(o.extension.packageJSON.version??""),r=String(o.extension.packageJSON.displayName??o.extension.packageJSON.name??"SQLite DB Viewer"),n=new C(o,o.extensionUri,t,r,e),c=a.window.registerCustomEditorProvider("sqliteDbViewer.dbViewer",n,{supportsMultipleEditorsPerDocument:!0}),d=a.commands.registerCommand("sqliteDbViewer.openFile",async l=>{let v=l??await q();v&&await U(v,t)}),p=a.workspace.onDidOpenTextDocument(async l=>{M(l.uri)&&await U(l.uri,t)});o.subscriptions.push(c,d,p,t)}function O(){}async function q(){let o=await a.window.showOpenDialog({canSelectMany:!1,filters:{SQLite:["db","sqlite","sqlite3"]}});return o==null?void 0:o[0]}var $=class extends a.Disposable{constructor(t,e){super(()=>this.dispose()),this.uri=t,this.dataUri=e,this._history=[],this._currentData=void 0}updateData(t){this._currentData=t}getData(){return this._currentData}setHistory(t){this._history=t}getHistory(){return this._history}clearHistory(){this._history=[]}dispose(){}},C=class{constructor(t,e,r,n,c){this.context=t,this.extensionUri=e,this.output=r,this.extensionDisplayName=n,this.extensionVersion=c,this._onDidChangeCustomDocument=new a.EventEmitter,this.onDidChangeCustomDocument=this._onDidChangeCustomDocument.event,this.webviews=new Map,this.pendingContentResolves=new Map,this._requestIdPool=0}async openCustomDocument(t,e,r){this.output.appendLine(`openCustomDocument: ${t.fsPath}`);let n=e.backupId?a.Uri.parse(e.backupId):t;return new $(t,n)}async resolveCustomEditor(t,e,r){this.output.appendLine(`resolveCustomEditor: ${t.uri.fsPath}`),this.webviews.set(t.uri.toString(),e),e.onDidDispose(()=>this.webviews.delete(t.uri.toString())),e.webview.options={enableScripts:!0,localResourceRoots:[a.Uri.joinPath(this.extensionUri,"webview-ui","dist"),a.Uri.joinPath(this.extensionUri,"dist","codicons")]};let n=!1,c,d=!1,p=!1,l=b.basename(t.uri.fsPath),v=()=>{d||(d=!0,e.webview.postMessage({type:"webview:config",displayName:this.extensionDisplayName,version:this.extensionVersion}))},g=async()=>{let i=t.dataUri.toString()!==t.uri.toString();try{c=await a.workspace.fs.readFile(t.dataUri),this.output.appendLine(`read db bytes: ${c.byteLength} (isBackup=${i})`)}catch(s){throw this.output.appendLine(`Failed to read content: ${s}`),s}if(i)try{let s=t.dataUri.with({path:t.dataUri.path+".history.json"}),h=await a.workspace.fs.readFile(s),f=new TextDecoder().decode(h),y=JSON.parse(f,(w,u)=>u&&typeof u=="object"&&u.$type==="blob"?new Uint8Array(u.data):u);if(Array.isArray(y)){t.setHistory(y),this.output.appendLine(`[Extension] Restored history from backup sibling: ${y.length} items`);for(let w of y)this._onDidChangeCustomDocument.fire({document:t,label:w.label||"Edit",undo:async()=>{p=!0;let u=this.webviews.get(t.uri.toString());u&&await u.webview.postMessage({type:"undo"})},redo:async()=>{p=!0;let u=this.webviews.get(t.uri.toString());u&&await u.webview.postMessage({type:"redo"})}})}}catch(s){this.output.appendLine(`[Extension] Failed to restore history from sibling (expected if clean backup): ${s}`)}else t.clearHistory();return c},S=async()=>{c||await g(),c&&n&&(this.output.appendLine(`sending db bytes: ${c.byteLength}`),e.webview.postMessage({type:"db:load",name:l,bytes:c}))};e.webview.onDidReceiveMessage(async i=>{if((i==null?void 0:i.type)==="db:history.sync"){let s=t.getHistory(),h=i.history||[];if(JSON.stringify(s)===JSON.stringify(h))return;this.output.appendLine(`[Extension] Received db:history.sync with ${h.length} items (Source: ${i.source})`),t.setHistory(h),i.source!=="system"&&this._onDidChangeCustomDocument.fire({document:t,label:"Edit",undo:async()=>{p=!0;let f=this.webviews.get(t.uri.toString());f&&await f.webview.postMessage({type:"undo"})},redo:async()=>{p=!0;let f=this.webviews.get(t.uri.toString());f&&await f.webview.postMessage({type:"redo"})}}),this.getContent(t).then(f=>{t.updateData(f),c=f,this.output.appendLine(`[Extension] Synced document state after history update: ${f.byteLength} bytes`)}).catch(f=>{this.output.appendLine(`[Extension] Sync failed after history update: ${f}`)});return}if((i==null?void 0:i.type)==="request:undo"){if(p=!1,await a.commands.executeCommand("undo"),!p){this.output.appendLine("[Extension] VS Code undo stack empty, triggering manual webview undo");let s=this.webviews.get(t.uri.toString());s&&await s.webview.postMessage({type:"undo"})}return}if((i==null?void 0:i.type)==="request:redo"){if(p=!1,await a.commands.executeCommand("redo"),!p){let s=this.webviews.get(t.uri.toString());s&&await s.webview.postMessage({type:"redo"})}return}if((i==null?void 0:i.type)==="webview:ready"){if(this.output.appendLine("webview:ready"),n=!0,v(),c){await S();let s=t.getHistory();await e.webview.postMessage({type:"db:history.load",history:s})}else try{let s=await g();await S();let h=t.getHistory();await e.webview.postMessage({type:"db:history.load",history:h})}catch(s){this.output.appendLine(`Error loading file on webview:ready: ${s}`)}return}if((i==null?void 0:i.type)==="db:edit"){this._onDidChangeCustomDocument.fire({document:t,label:i.label??"Edit",undo:async()=>{await e.webview.postMessage({type:"undo"}),this.getContent(t).then(s=>{t.updateData(s),c=s})},redo:async()=>{await e.webview.postMessage({type:"redo"}),this.getContent(t).then(s=>{t.updateData(s),c=s})}}),this.getContent(t).then(s=>{t.updateData(s),c=s,this.output.appendLine(`Synced document state: ${s.byteLength} bytes`)}).catch(s=>{this.output.appendLine(`Sync failed: ${s}`)});return}if((i==null?void 0:i.type)==="webview:refresh"){this.output.appendLine("webview:refresh"),g().then(()=>S());return}if((i==null?void 0:i.type)==="request:save"){a.commands.executeCommand("workbench.action.files.save");return}if((i==null?void 0:i.type)==="db:content"){if(typeof i.requestId=="number"&&i.data){let s=i.data,h=L(s);h&&this.resolveContent(i.requestId,h)}return}if((i==null?void 0:i.type)==="db:save"){let s=L(i.bytes??i.data);return}if((i==null?void 0:i.type)==="export:file"){let s=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",h=typeof i.text=="string"?i.text:"";if(!h){e.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}let f=b.extname(s).replace(".","")||"txt",y=b.dirname(t.uri.fsPath),w=a.Uri.file(b.join(y,s));(async()=>{let u=await a.window.showSaveDialog({defaultUri:w,filters:{[f.toUpperCase()]:[f]}});if(!u){e.webview.postMessage({type:"export:result",ok:!1,message:"Save canceled."});return}await a.workspace.fs.writeFile(u,Buffer.from(h,"utf8")),e.webview.postMessage({type:"export:result",ok:!0,message:`Saved ${b.basename(u.fsPath)}`})})().catch(u=>{let k=u instanceof Error?u.message:String(u);e.webview.postMessage({type:"export:result",ok:!1,message:k})});return}if((i==null?void 0:i.type)==="export:save"){let s=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",h=typeof i.text=="string"?i.text:"";if(!h){e.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}let f=b.dirname(t.uri.fsPath),y=b.join(f,s);a.workspace.fs.writeFile(a.Uri.file(y),Buffer.from(h,"utf8")).then(()=>{this.output.appendLine(`saved export: ${y}`),e.webview.postMessage({type:"export:result",ok:!0,message:`Saved to ${y}`})},w=>{let u=w instanceof Error?w.message:String(w);e.webview.postMessage({type:"export:result",ok:!1,message:u})});return}if((i==null?void 0:i.type)==="webview:log"){i.message&&this.output.appendLine(`webview log: ${i.message}`);return}if((i==null?void 0:i.type)==="webview:error"){let s=[i.message?`message=${i.message}`:void 0,i.source?`source=${i.source}`:void 0,i.line?`line=${i.line}`:void 0,i.column?`column=${i.column}`:void 0].filter(Boolean).join(" ");this.output.appendLine(`webview error: ${s}`),i.stack&&this.output.appendLine(String(i.stack))}}),await g(),e.webview.html=B(e.webview,this.extensionUri),n&&await S()}resolveContent(t,e){let r=this.pendingContentResolves.get(t);r&&(r(e),this.pendingContentResolves.delete(t))}async getContent(t){let e=this.webviews.get(t.uri.toString());if(!e)throw new Error("No panel found for document");let r=++this._requestIdPool,n=new Promise((c,d)=>{this.pendingContentResolves.set(r,c),setTimeout(()=>{this.pendingContentResolves.has(r)&&(this.pendingContentResolves.delete(r),d(new Error("Timeout waiting for content")))},5e3)});return await e.webview.postMessage({type:"do-get-content",saveId:r}),n}async saveCustomDocument(t,e){try{let r;try{r=await this.getContent(t),t.updateData(r)}catch(c){let d=t.getData();if(d)r=d;else throw c}await a.workspace.fs.writeFile(t.uri,r);let n=this.webviews.get(t.uri.toString());n&&(n.webview.postMessage({type:"db:save:result",ok:!0,message:"Saved"}),n.webview.postMessage({type:"db:saved"}))}catch(r){throw this.output.appendLine(`Save failed: ${r}`),r}}async saveCustomDocumentAs(t,e,r){try{let n;try{n=await this.getContent(t),t.updateData(n)}catch(c){let d=t.getData();if(d)n=d;else throw c}await a.workspace.fs.writeFile(e,n)}catch(n){throw this.output.appendLine(`Save As failed: ${n}`),this.output.appendLine(`Save As failed: ${n}`),n}}async revertCustomDocument(t,e){t.clearHistory();let r=this.webviews.get(t.uri.toString());r&&await r.webview.postMessage({type:"webview:refresh"})}async saveHistoryToUri(t,e){try{let r=t.getHistory(),n=JSON.stringify(r,(d,p)=>p instanceof Uint8Array?{$type:"blob",data:Array.from(p)}:this.isUint8Array(p)?{$type:"blob",data:Array.from(p)}:p),c=new TextEncoder().encode(n);await a.workspace.fs.writeFile(e,c),this.output.appendLine(`[Extension] History saved to ${e.fsPath}`)}catch(r){this.output.appendLine(`[Extension] Failed to save history: ${r}`)}}isUint8Array(t){return t instanceof Uint8Array||t&&t.constructor&&t.constructor.name==="Uint8Array"}async backupCustomDocument(t,e,r){let n;try{n=await this.getContent(t),t.updateData(n)}catch(d){let p=t.getData();if(p)this.output.appendLine("Using cached data for backup"),n=p;else throw d}await a.workspace.fs.writeFile(e.destination,n);let c=e.destination.with({path:e.destination.path+".history.json"});return await this.saveHistoryToUri(t,c),{id:e.destination.toString(),delete:()=>{try{a.workspace.fs.delete(e.destination),a.workspace.fs.delete(c)}catch{}}}}};async function U(o,t){if(!M(o))return;let e=o.toString();if(!D.has(e)){D.add(e),setTimeout(()=>D.delete(e),1500);try{await a.commands.executeCommand("vscode.openWith",o,"sqliteDbViewer.dbViewer")}catch(r){let n=r instanceof Error?r.message:String(r);t.appendLine(`openWith failed: ${n}`),a.window.showErrorMessage(`SQLite DB Viewer could not be opened: ${n}`)}}}var D=new Set;function M(o){let t=b.extname(o.fsPath).toLowerCase();return t===".db"||t===".sqlite"||t===".sqlite3"}function B(o,t){let e=a.Uri.joinPath(t,"webview-ui","dist"),r=a.Uri.joinPath(e,"index.html"),n=j.readFileSync(r.fsPath,"utf8"),c=Date.now().toString(),d=N(),p=["default-src 'none'",`img-src ${o.cspSource} blob: data:`,`style-src ${o.cspSource} 'unsafe-inline'`,`font-src ${o.cspSource}`,`connect-src ${o.cspSource}`,`worker-src ${o.cspSource}`,`script-src 'nonce-${d}' 'wasm-unsafe-eval'`].join("; "),l=o.asWebviewUri(a.Uri.joinPath(t,"dist","codicons","codicon.css"));n=n.replace("<head>",`<head>
<meta http-equiv="Content-Security-Policy" content="${p}">
<link rel="stylesheet" href="${l}">`);let v=o.asWebviewUri(e).toString();return n=n.replace(/(href|src)=\"\.\/?assets\//g,`$1="${v}/assets/`),n=n.replace(/(href|src)=\"\/assets\//g,`$1="${v}/assets/`),n=n.replace(/assets\/[^\"']+\.(?:js|css|wasm)/g,g=>`${g}?v=${c}`),n=n.replace(/<script /g,`<script nonce="${d}" `),n}function N(){let o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let e=0;e<32;e+=1)t+=o.charAt(Math.floor(Math.random()*o.length));return t}function L(o){if(o instanceof Uint8Array)return o;if(o instanceof ArrayBuffer)return new Uint8Array(o);if(Array.isArray(o))return Uint8Array.from(o);if(o&&typeof o=="object"){let t=o;if(t.type==="Buffer"&&Array.isArray(t.data)||Array.isArray(t.data))return Uint8Array.from(t.data);let e=Object.values(t);if(e.length&&e.every(r=>typeof r=="number"))return Uint8Array.from(e)}}
