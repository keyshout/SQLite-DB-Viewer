"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,o){o===void 0&&(o=i);var r=Object.getOwnPropertyDescriptor(e,i);(!r||("get"in r?!e.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,o,r)}:function(t,e,i,o){o===void 0&&(o=i),t[o]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(){var t=function(e){return t=Object.getOwnPropertyNames||function(i){var o=[];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(o[o.length]=r);return o},t(e)};return function(e){if(e&&e.__esModule)return e;var i={};if(e!=null)for(var o=t(e),r=0;r<o.length;r++)o[r]!=="default"&&__createBinding(i,e,o[r]);return __setModuleDefault(i,e),i}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.activate=activate,exports.deactivate=deactivate;const fs=__importStar(require("fs")),path=__importStar(require("path")),vscode=__importStar(require("vscode"));function activate(t){const e=vscode.window.createOutputChannel("New Db Viewer");e.appendLine("Activated");const i=String(t.extension.packageJSON.version??""),o=String(t.extension.packageJSON.displayName??t.extension.packageJSON.name??"New Db Viewer"),r=new DbViewerCustomEditorProvider(t.extensionUri,e,o,i),l=vscode.window.registerCustomEditorProvider("newDbViewer.dbViewer",r,{supportsMultipleEditorsPerDocument:!0}),h=vscode.commands.registerCommand("newDbViewer.openFile",async c=>{const u=c??await pickDatabaseFile();u&&await openWithViewer(u,e)}),y=vscode.workspace.onDidOpenTextDocument(async c=>{isDatabaseFile(c.uri)&&await openWithViewer(c.uri,e)});t.subscriptions.push(l,h,y,e)}function deactivate(){}async function pickDatabaseFile(){const t=await vscode.window.showOpenDialog({canSelectMany:!1,filters:{SQLite:["db","sqlite","sqlite3"]}});return t==null?void 0:t[0]}class DbViewerDocument{constructor(e){this.uri=e}dispose(){}}class DbViewerCustomEditorProvider{constructor(e,i,o,r){this.extensionUri=e,this.output=i,this.extensionDisplayName=o,this.extensionVersion=r}async openCustomDocument(e){return this.output.appendLine(`openCustomDocument: ${e.fsPath}`),new DbViewerDocument(e)}async resolveCustomEditor(e,i){this.output.appendLine(`resolveCustomEditor: ${e.uri.fsPath}`),i.webview.options={enableScripts:!0,localResourceRoots:[vscode.Uri.joinPath(this.extensionUri,"webview-ui","dist"),vscode.Uri.joinPath(this.extensionUri,"dist","codicons")]};let o=!1,r,l=!1;const h=path.basename(e.uri.fsPath),y=()=>{l||(l=!0,i.webview.postMessage({type:"webview:config",displayName:this.extensionDisplayName,version:this.extensionVersion}))},c=async()=>(r=await vscode.workspace.fs.readFile(e.uri),this.output.appendLine(`read db bytes: ${r.byteLength}`),r),u=async()=>{r||await c(),r&&o&&(this.output.appendLine(`sending db bytes: ${r.byteLength}`),i.webview.postMessage({type:"db:load",name:h,bytes:r}))};i.webview.onDidReceiveMessage(n=>{if((n==null?void 0:n.type)==="webview:ready"){this.output.appendLine("webview:ready"),o=!0,y(),u();return}if((n==null?void 0:n.type)==="webview:refresh"){this.output.appendLine("webview:refresh"),c().then(()=>u());return}if((n==null?void 0:n.type)==="db:save"){const s=normalizeMessageBytes(n.bytes),p=n.saveId;if(this.output.appendLine(`db:save received bytes=${s?s.byteLength:"invalid"}`),!s){const a="db:save received invalid bytes";this.output.appendLine(a),i.webview.postMessage({type:"db:save:result",ok:!1,message:a,saveId:p});return}vscode.workspace.fs.writeFile(e.uri,s).then(()=>{r=s,this.output.appendLine(`db saved: ${e.uri.fsPath}`),i.webview.postMessage({type:"db:save:result",ok:!0,message:"Saved",saveId:p})},a=>{const f=a instanceof Error?a.message:String(a);this.output.appendLine(`db save failed: ${f}`),i.webview.postMessage({type:"db:save:result",ok:!1,message:f,saveId:p})});return}if((n==null?void 0:n.type)==="export:file"){const s=typeof n.name=="string"&&n.name.trim()?n.name.trim():"export.txt",p=typeof n.text=="string"?n.text:"";if(!p){i.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}const a=path.extname(s).replace(".","")||"txt",f=path.dirname(e.uri.fsPath),w=vscode.Uri.file(path.join(f,s));(async()=>{const d=await vscode.window.showSaveDialog({defaultUri:w,filters:{[a.toUpperCase()]:[a]}});if(!d){i.webview.postMessage({type:"export:result",ok:!1,message:"Save canceled."});return}await vscode.workspace.fs.writeFile(d,Buffer.from(p,"utf8")),i.webview.postMessage({type:"export:result",ok:!0,message:`Saved ${path.basename(d.fsPath)}`})})().catch(d=>{const v=d instanceof Error?d.message:String(d);i.webview.postMessage({type:"export:result",ok:!1,message:v})});return}if((n==null?void 0:n.type)==="export:save"){const s=typeof n.name=="string"&&n.name.trim()?n.name.trim():"export.txt",p=typeof n.text=="string"?n.text:"";if(!p){i.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}const a=path.dirname(e.uri.fsPath),f=path.join(a,s);vscode.workspace.fs.writeFile(vscode.Uri.file(f),Buffer.from(p,"utf8")).then(()=>{this.output.appendLine(`saved export: ${f}`),i.webview.postMessage({type:"export:result",ok:!0,message:`Saved to ${f}`})},w=>{const d=w instanceof Error?w.message:String(w);i.webview.postMessage({type:"export:result",ok:!1,message:d})});return}if((n==null?void 0:n.type)==="webview:log"){n.message&&this.output.appendLine(`webview log: ${n.message}`);return}if((n==null?void 0:n.type)==="webview:error"){const s=[n.message?`message=${n.message}`:void 0,n.source?`source=${n.source}`:void 0,n.line?`line=${n.line}`:void 0,n.column?`column=${n.column}`:void 0].filter(Boolean).join(" ");this.output.appendLine(`webview error: ${s}`),n.stack&&this.output.appendLine(String(n.stack))}}),await c(),i.webview.html=getWebviewHtml(i.webview,this.extensionUri),o&&await u()}}async function openWithViewer(t,e){if(!isDatabaseFile(t))return;const i=t.toString();if(!openGate.has(i)){openGate.add(i),setTimeout(()=>openGate.delete(i),1500);try{await vscode.commands.executeCommand("vscode.openWith",t,"newDbViewer.dbViewer")}catch(o){const r=o instanceof Error?o.message:String(o);e.appendLine(`openWith failed: ${r}`),vscode.window.showErrorMessage(`New Db Viewer could not be opened: ${r}`)}}}const openGate=new Set;function isDatabaseFile(t){const e=path.extname(t.fsPath).toLowerCase();return e===".db"||e===".sqlite"||e===".sqlite3"}function getWebviewHtml(t,e){const i=vscode.Uri.joinPath(e,"webview-ui","dist"),o=vscode.Uri.joinPath(i,"index.html");let r=fs.readFileSync(o.fsPath,"utf8");const l=Date.now().toString(),h=getNonce(),y=["default-src 'none'",`img-src ${t.cspSource} blob: data:`,`style-src ${t.cspSource} 'unsafe-inline'`,`font-src ${t.cspSource}`,`connect-src ${t.cspSource}`,`worker-src ${t.cspSource}`,`script-src 'nonce-${h}' 'wasm-unsafe-eval'`].join("; "),c=t.asWebviewUri(vscode.Uri.joinPath(e,"dist","codicons","codicon.css"));r=r.replace("<head>",`<head>
<meta http-equiv="Content-Security-Policy" content="${y}">
<link rel="stylesheet" href="${c}">`);const u=t.asWebviewUri(i).toString();return r=r.replace(/(href|src)=\"\.\/?assets\//g,`$1="${u}/assets/`),r=r.replace(/(href|src)=\"\/assets\//g,`$1="${u}/assets/`),r=r.replace(/assets\/[^\"']+\.(?:js|css|wasm)/g,n=>`${n}?v=${l}`),r=r.replace(/<script /g,`<script nonce="${h}" `),r}function getNonce(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let i=0;i<32;i+=1)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function normalizeMessageBytes(t){if(t instanceof Uint8Array)return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(Array.isArray(t))return Uint8Array.from(t);if(t&&typeof t=="object"){const e=t;if(e.type==="Buffer"&&Array.isArray(e.data)||Array.isArray(e.data))return Uint8Array.from(e.data);const i=Object.values(e);if(i.length&&i.every(o=>typeof o=="number"))return Uint8Array.from(i)}}
