"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,t,e,r){r===void 0&&(r=e);var n=Object.getOwnPropertyDescriptor(t,e);(!n||("get"in n?!t.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(o,r,n)}:function(o,t,e,r){r===void 0&&(r=e),o[r]=t[e]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,t){Object.defineProperty(o,"default",{enumerable:!0,value:t})}:function(o,t){o.default=t}),__importStar=this&&this.__importStar||function(){var o=function(t){return o=Object.getOwnPropertyNames||function(e){var r=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[r.length]=n);return r},o(t)};return function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r=o(t),n=0;n<r.length;n++)r[n]!=="default"&&__createBinding(e,t,r[n]);return __setModuleDefault(e,t),e}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.activate=activate,exports.deactivate=deactivate;const fs=__importStar(require("fs")),path=__importStar(require("path")),vscode=__importStar(require("vscode"));function activate(o){const t=vscode.window.createOutputChannel("SQLite DB Viewer");t.appendLine("Activated");const e=String(o.extension.packageJSON.version??""),r=String(o.extension.packageJSON.displayName??o.extension.packageJSON.name??"SQLite DB Viewer"),n=new DbViewerCustomEditorProvider(o,o.extensionUri,t,r,e),a=vscode.window.registerCustomEditorProvider("sqliteDbViewer.dbViewer",n,{supportsMultipleEditorsPerDocument:!0}),u=vscode.commands.registerCommand("sqliteDbViewer.openFile",async y=>{const w=y??await pickDatabaseFile();w&&await openWithViewer(w,t)}),c=vscode.workspace.onDidOpenTextDocument(async y=>{isDatabaseFile(y.uri)&&await openWithViewer(y.uri,t)});o.subscriptions.push(a,u,c,t)}function deactivate(){}async function pickDatabaseFile(){const o=await vscode.window.showOpenDialog({canSelectMany:!1,filters:{SQLite:["db","sqlite","sqlite3"]}});return o==null?void 0:o[0]}class DbViewerDocument extends vscode.Disposable{constructor(t,e){super(()=>this.dispose()),this.uri=t,this.dataUri=e,this._history=[],this._currentData=void 0}updateData(t){this._currentData=t}getData(){return this._currentData}setHistory(t){this._history=t}getHistory(){return this._history}clearHistory(){this._history=[]}dispose(){}}class DbViewerCustomEditorProvider{constructor(t,e,r,n,a){this.context=t,this.extensionUri=e,this.output=r,this.extensionDisplayName=n,this.extensionVersion=a,this._onDidChangeCustomDocument=new vscode.EventEmitter,this.onDidChangeCustomDocument=this._onDidChangeCustomDocument.event,this.webviews=new Map,this.pendingContentResolves=new Map,this._requestIdPool=0}async openCustomDocument(t,e,r){this.output.appendLine(`openCustomDocument: ${t.fsPath}`);const n=e.backupId?vscode.Uri.parse(e.backupId):t;return new DbViewerDocument(t,n)}async resolveCustomEditor(t,e,r){this.output.appendLine(`resolveCustomEditor: ${t.uri.fsPath}`),this.webviews.set(t.uri.toString(),e),e.onDidDispose(()=>this.webviews.delete(t.uri.toString())),e.webview.options={enableScripts:!0,localResourceRoots:[vscode.Uri.joinPath(this.extensionUri,"webview-ui","dist"),vscode.Uri.joinPath(this.extensionUri,"dist","codicons")]};let n=!1,a,u=!1,c=!1;const y=path.basename(t.uri.fsPath),w=()=>{u||(u=!0,e.webview.postMessage({type:"webview:config",displayName:this.extensionDisplayName,version:this.extensionVersion}))},b=async()=>{const i=t.dataUri.toString()!==t.uri.toString();try{a=await vscode.workspace.fs.readFile(t.dataUri),this.output.appendLine(`read db bytes: ${a.byteLength} (isBackup=${i})`)}catch(s){throw this.output.appendLine(`Failed to read content: ${s}`),s}if(i)try{const s=t.dataUri.with({path:t.dataUri.path+".history.json"}),f=await vscode.workspace.fs.readFile(s),d=new TextDecoder().decode(f),h=JSON.parse(d,(l,p)=>p&&typeof p=="object"&&p.$type==="blob"?new Uint8Array(p.data):p);if(Array.isArray(h)){t.setHistory(h),this.output.appendLine(`[Extension] Restored history from backup sibling: ${h.length} items`);for(const l of h)this._onDidChangeCustomDocument.fire({document:t,label:l.label||"Edit",undo:async()=>{c=!0;const p=this.webviews.get(t.uri.toString());p&&await p.webview.postMessage({type:"undo"})},redo:async()=>{c=!0;const p=this.webviews.get(t.uri.toString());p&&await p.webview.postMessage({type:"redo"})}})}}catch(s){this.output.appendLine(`[Extension] Failed to restore history from sibling (expected if clean backup): ${s}`)}else t.clearHistory();return a},v=async()=>{a||await b(),a&&n&&(this.output.appendLine(`sending db bytes: ${a.byteLength}`),e.webview.postMessage({type:"db:load",name:y,bytes:a}))};e.webview.onDidReceiveMessage(async i=>{if((i==null?void 0:i.type)==="db:history.sync"){const s=t.getHistory(),f=i.history||[];if(JSON.stringify(s)===JSON.stringify(f))return;this.output.appendLine(`[Extension] Received db:history.sync with ${f.length} items (Source: ${i.source})`),t.setHistory(f),i.source!=="system"&&this._onDidChangeCustomDocument.fire({document:t,label:"Edit",undo:async()=>{c=!0;const d=this.webviews.get(t.uri.toString());d&&await d.webview.postMessage({type:"undo"})},redo:async()=>{c=!0;const d=this.webviews.get(t.uri.toString());d&&await d.webview.postMessage({type:"redo"})}}),this.getContent(t).then(d=>{t.updateData(d),a=d,this.output.appendLine(`[Extension] Synced document state after history update: ${d.byteLength} bytes`)}).catch(d=>{this.output.appendLine(`[Extension] Sync failed after history update: ${d}`)});return}if((i==null?void 0:i.type)==="request:undo"){if(c=!1,await vscode.commands.executeCommand("undo"),!c){this.output.appendLine("[Extension] VS Code undo stack empty, triggering manual webview undo");const s=this.webviews.get(t.uri.toString());s&&await s.webview.postMessage({type:"undo"})}return}if((i==null?void 0:i.type)==="request:redo"){if(c=!1,await vscode.commands.executeCommand("redo"),!c){const s=this.webviews.get(t.uri.toString());s&&await s.webview.postMessage({type:"redo"})}return}if((i==null?void 0:i.type)==="webview:ready"){if(this.output.appendLine("webview:ready"),n=!0,w(),a){await v();const s=t.getHistory();await e.webview.postMessage({type:"db:history.load",history:s})}else try{const s=await b();await v();const f=t.getHistory();await e.webview.postMessage({type:"db:history.load",history:f})}catch(s){this.output.appendLine(`Error loading file on webview:ready: ${s}`)}return}if((i==null?void 0:i.type)==="db:edit"){this._onDidChangeCustomDocument.fire({document:t,label:i.label??"Edit",undo:async()=>{await e.webview.postMessage({type:"undo"}),this.getContent(t).then(s=>{t.updateData(s),a=s})},redo:async()=>{await e.webview.postMessage({type:"redo"}),this.getContent(t).then(s=>{t.updateData(s),a=s})}}),this.getContent(t).then(s=>{t.updateData(s),a=s,this.output.appendLine(`Synced document state: ${s.byteLength} bytes`)}).catch(s=>{this.output.appendLine(`Sync failed: ${s}`)});return}if((i==null?void 0:i.type)==="webview:refresh"){this.output.appendLine("webview:refresh"),b().then(()=>v());return}if((i==null?void 0:i.type)==="request:save"){vscode.commands.executeCommand("workbench.action.files.save");return}if((i==null?void 0:i.type)==="db:content"){if(typeof i.requestId=="number"&&i.data){const s=i.data,f=normalizeMessageBytes(s);f&&this.resolveContent(i.requestId,f)}return}if((i==null?void 0:i.type)==="db:save"){const s=normalizeMessageBytes(i.bytes??i.data);return}if((i==null?void 0:i.type)==="export:file"){const s=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",f=typeof i.text=="string"?i.text:"";if(!f){e.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}const d=path.extname(s).replace(".","")||"txt",h=path.dirname(t.uri.fsPath),l=vscode.Uri.file(path.join(h,s));(async()=>{const p=await vscode.window.showSaveDialog({defaultUri:l,filters:{[d.toUpperCase()]:[d]}});if(!p){e.webview.postMessage({type:"export:result",ok:!1,message:"Save canceled."});return}await vscode.workspace.fs.writeFile(p,Buffer.from(f,"utf8")),e.webview.postMessage({type:"export:result",ok:!0,message:`Saved ${path.basename(p.fsPath)}`})})().catch(p=>{const g=p instanceof Error?p.message:String(p);e.webview.postMessage({type:"export:result",ok:!1,message:g})});return}if((i==null?void 0:i.type)==="export:save"){const s=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",f=typeof i.text=="string"?i.text:"";if(!f){e.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}const d=path.dirname(t.uri.fsPath),h=path.join(d,s);vscode.workspace.fs.writeFile(vscode.Uri.file(h),Buffer.from(f,"utf8")).then(()=>{this.output.appendLine(`saved export: ${h}`),e.webview.postMessage({type:"export:result",ok:!0,message:`Saved to ${h}`})},l=>{const p=l instanceof Error?l.message:String(l);e.webview.postMessage({type:"export:result",ok:!1,message:p})});return}if((i==null?void 0:i.type)==="webview:log"){i.message&&this.output.appendLine(`webview log: ${i.message}`);return}if((i==null?void 0:i.type)==="webview:error"){const s=[i.message?`message=${i.message}`:void 0,i.source?`source=${i.source}`:void 0,i.line?`line=${i.line}`:void 0,i.column?`column=${i.column}`:void 0].filter(Boolean).join(" ");this.output.appendLine(`webview error: ${s}`),i.stack&&this.output.appendLine(String(i.stack))}}),await b(),e.webview.html=getWebviewHtml(e.webview,this.extensionUri),n&&await v()}resolveContent(t,e){const r=this.pendingContentResolves.get(t);r&&(r(e),this.pendingContentResolves.delete(t))}async getContent(t){const e=this.webviews.get(t.uri.toString());if(!e)throw new Error("No panel found for document");const r=++this._requestIdPool,n=new Promise((a,u)=>{this.pendingContentResolves.set(r,a),setTimeout(()=>{this.pendingContentResolves.has(r)&&(this.pendingContentResolves.delete(r),u(new Error("Timeout waiting for content")))},5e3)});return await e.webview.postMessage({type:"do-get-content",saveId:r}),n}async saveCustomDocument(t,e){try{let r;try{r=await this.getContent(t),t.updateData(r)}catch(a){const u=t.getData();if(u)r=u;else throw a}await vscode.workspace.fs.writeFile(t.uri,r);const n=this.webviews.get(t.uri.toString());n&&(n.webview.postMessage({type:"db:save:result",ok:!0,message:"Saved"}),n.webview.postMessage({type:"db:saved"}))}catch(r){throw this.output.appendLine(`Save failed: ${r}`),r}}async saveCustomDocumentAs(t,e,r){try{let n;try{n=await this.getContent(t),t.updateData(n)}catch(a){const u=t.getData();if(u)n=u;else throw a}await vscode.workspace.fs.writeFile(e,n)}catch(n){throw this.output.appendLine(`Save As failed: ${n}`),this.output.appendLine(`Save As failed: ${n}`),n}}async revertCustomDocument(t,e){t.clearHistory();const r=this.webviews.get(t.uri.toString());r&&await r.webview.postMessage({type:"webview:refresh"})}async saveHistoryToUri(t,e){try{const r=t.getHistory(),n=JSON.stringify(r,(u,c)=>c instanceof Uint8Array?{$type:"blob",data:Array.from(c)}:this.isUint8Array(c)?{$type:"blob",data:Array.from(c)}:c),a=new TextEncoder().encode(n);await vscode.workspace.fs.writeFile(e,a),this.output.appendLine(`[Extension] History saved to ${e.fsPath}`)}catch(r){this.output.appendLine(`[Extension] Failed to save history: ${r}`)}}isUint8Array(t){return t instanceof Uint8Array||t&&t.constructor&&t.constructor.name==="Uint8Array"}async backupCustomDocument(t,e,r){let n;try{n=await this.getContent(t),t.updateData(n)}catch(u){const c=t.getData();if(c)this.output.appendLine("Using cached data for backup"),n=c;else throw u}await vscode.workspace.fs.writeFile(e.destination,n);const a=e.destination.with({path:e.destination.path+".history.json"});return await this.saveHistoryToUri(t,a),{id:e.destination.toString(),delete:()=>{try{vscode.workspace.fs.delete(e.destination),vscode.workspace.fs.delete(a)}catch{}}}}}async function openWithViewer(o,t){if(!isDatabaseFile(o))return;const e=o.toString();if(!openGate.has(e)){openGate.add(e),setTimeout(()=>openGate.delete(e),1500);try{await vscode.commands.executeCommand("vscode.openWith",o,"sqliteDbViewer.dbViewer")}catch(r){const n=r instanceof Error?r.message:String(r);t.appendLine(`openWith failed: ${n}`),vscode.window.showErrorMessage(`SQLite DB Viewer could not be opened: ${n}`)}}}const openGate=new Set;function isDatabaseFile(o){const t=path.extname(o.fsPath).toLowerCase();return t===".db"||t===".sqlite"||t===".sqlite3"}function getWebviewHtml(o,t){const e=vscode.Uri.joinPath(t,"webview-ui","dist"),r=vscode.Uri.joinPath(e,"index.html");let n=fs.readFileSync(r.fsPath,"utf8");const a=Date.now().toString(),u=getNonce(),c=["default-src 'none'",`img-src ${o.cspSource} blob: data:`,`style-src ${o.cspSource} 'unsafe-inline'`,`font-src ${o.cspSource}`,`connect-src ${o.cspSource}`,`worker-src ${o.cspSource}`,`script-src 'nonce-${u}' 'wasm-unsafe-eval'`].join("; "),y=o.asWebviewUri(vscode.Uri.joinPath(t,"dist","codicons","codicon.css"));n=n.replace("<head>",`<head>
<meta http-equiv="Content-Security-Policy" content="${c}">
<link rel="stylesheet" href="${y}">`);const w=o.asWebviewUri(e).toString();return n=n.replace(/(href|src)=\"\.\/?assets\//g,`$1="${w}/assets/`),n=n.replace(/(href|src)=\"\/assets\//g,`$1="${w}/assets/`),n=n.replace(/assets\/[^\"']+\.(?:js|css|wasm)/g,b=>`${b}?v=${a}`),n=n.replace(/<script /g,`<script nonce="${u}" `),n}function getNonce(){const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let e=0;e<32;e+=1)t+=o.charAt(Math.floor(Math.random()*o.length));return t}function normalizeMessageBytes(o){if(o instanceof Uint8Array)return o;if(o instanceof ArrayBuffer)return new Uint8Array(o);if(Array.isArray(o))return Uint8Array.from(o);if(o&&typeof o=="object"){const t=o;if(t.type==="Buffer"&&Array.isArray(t.data)||Array.isArray(t.data))return Uint8Array.from(t.data);const e=Object.values(t);if(e.length&&e.every(r=>typeof r=="number"))return Uint8Array.from(e)}}
