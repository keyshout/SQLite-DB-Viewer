"use strict";var L=exports&&exports.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,n,s)}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),k=exports&&exports.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),x=exports&&exports.__importStar||function(){var r=function(e){return r=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},r(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=r(e),s=0;s<n.length;s++)n[s]!=="default"&&L(t,e,n[s]);return k(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.activate=P;exports.deactivate=j;var A=x(require("fs")),b=x(require("path")),o=x(require("vscode"));function P(r){let e=o.window.createOutputChannel("SQLite DB Viewer");e.appendLine("Activated");let t=String(r.extension.packageJSON.version??""),n=String(r.extension.packageJSON.displayName??r.extension.packageJSON.name??"SQLite DB Viewer"),s=new $(r,r.extensionUri,e,n,t),c=o.window.registerCustomEditorProvider("sqliteDbViewer.dbViewer",s,{supportsMultipleEditorsPerDocument:!0}),p=o.commands.registerCommand("sqliteDbViewer.openFile",async y=>{let v=y??await E();v&&await U(v,e)}),w=o.workspace.onDidOpenTextDocument(async y=>{_(y.uri)&&await U(y.uri,e)});r.subscriptions.push(c,p,w,e)}function j(){}async function E(){let r=await o.window.showOpenDialog({canSelectMany:!1,filters:{SQLite:["db","sqlite","sqlite3"]}});return r==null?void 0:r[0]}var C=class extends o.Disposable{constructor(e,t){super(()=>this.dispose()),this.uri=e,this.dataUri=t,this._history=[],this._currentData=void 0}updateData(e){this._currentData=e}getData(){return this._currentData}setHistory(e){this._history=e}getHistory(){return this._history}clearHistory(){this._history=[]}dispose(){}},$=class{constructor(e,t,n,s,c){this.context=e,this.extensionUri=t,this.output=n,this.extensionDisplayName=s,this.extensionVersion=c,this._onDidChangeCustomDocument=new o.EventEmitter,this.onDidChangeCustomDocument=this._onDidChangeCustomDocument.event,this.webviews=new Map,this.pendingContentResolves=new Map,this._requestIdPool=0}async openCustomDocument(e,t,n){this.output.appendLine(`openCustomDocument: ${e.fsPath}`);let s=t.backupId?o.Uri.parse(t.backupId):e;return new C(e,s)}async resolveCustomEditor(e,t,n){this.output.appendLine(`resolveCustomEditor: ${e.uri.fsPath}`),this.webviews.set(e.uri.toString(),t),t.onDidDispose(()=>this.webviews.delete(e.uri.toString())),t.webview.options={enableScripts:!0,localResourceRoots:[o.Uri.joinPath(this.extensionUri,"webview-ui","dist"),o.Uri.joinPath(this.extensionUri,"dist","codicons")]};let s=!1,c,p=!1,w=!1,y=b.basename(e.uri.fsPath),v=()=>{w||(w=!0,t.webview.postMessage({type:"webview:config",displayName:this.extensionDisplayName,version:this.extensionVersion}))},g=async()=>{let i=e.dataUri.toString()!==e.uri.toString();try{c=await o.workspace.fs.readFile(e.dataUri),this.output.appendLine(`read db bytes: ${c.byteLength} (isBackup=${i})`)}catch(a){throw this.output.appendLine(`Failed to read content: ${a}`),a}if(i)try{let a=e.dataUri.with({path:e.dataUri.path+".history.json"}),f=await o.workspace.fs.readFile(a),d=new TextDecoder().decode(f),h=JSON.parse(d,(l,u)=>u&&typeof u=="object"&&u.$type==="blob"?new Uint8Array(u.data):u);if(Array.isArray(h)){e.setHistory(h),this.output.appendLine(`[Extension] Restored history from backup sibling: ${h.length} items`);for(let l of h)this._onDidChangeCustomDocument.fire({document:e,label:l.label||"Edit",undo:async()=>{p=!0;let u=this.webviews.get(e.uri.toString());u&&await u.webview.postMessage({type:"undo"})},redo:async()=>{p=!0;let u=this.webviews.get(e.uri.toString());u&&await u.webview.postMessage({type:"redo"})}})}}catch(a){this.output.appendLine(`[Extension] Failed to restore history from sibling (expected if clean backup): ${a}`)}else e.clearHistory();return c},S=async()=>{c||await g(),c&&s&&(this.output.appendLine(`sending db bytes: ${c.byteLength}`),t.webview.postMessage({type:"db:load",name:y,bytes:c}))};t.webview.onDidReceiveMessage(async i=>{if((i==null?void 0:i.type)==="db:history.sync"){let a=e.getHistory(),f=i.history||[];if(JSON.stringify(a)===JSON.stringify(f))return;this.output.appendLine(`[Extension] Received db:history.sync with ${f.length} items (Source: ${i.source})`),e.setHistory(f),i.source!=="system"&&this._onDidChangeCustomDocument.fire({document:e,label:"Edit",undo:async()=>{p=!0;let d=this.webviews.get(e.uri.toString());d&&await d.webview.postMessage({type:"undo"})},redo:async()=>{p=!0;let d=this.webviews.get(e.uri.toString());d&&await d.webview.postMessage({type:"redo"})}}),this.getContent(e).then(d=>{e.updateData(d),c=d,this.output.appendLine(`[Extension] Synced document state after history update: ${d.byteLength} bytes`)}).catch(d=>{this.output.appendLine(`[Extension] Sync failed after history update: ${d}`)});return}if((i==null?void 0:i.type)==="request:undo"){if(p=!1,await o.commands.executeCommand("undo"),!p){this.output.appendLine("[Extension] VS Code undo stack empty, triggering manual webview undo");let a=this.webviews.get(e.uri.toString());a&&await a.webview.postMessage({type:"undo"})}return}if((i==null?void 0:i.type)==="request:redo"){if(p=!1,await o.commands.executeCommand("redo"),!p){let a=this.webviews.get(e.uri.toString());a&&await a.webview.postMessage({type:"redo"})}return}if((i==null?void 0:i.type)==="webview:ready"){if(this.output.appendLine("webview:ready"),s=!0,v(),c){await S();let a=e.getHistory();await t.webview.postMessage({type:"db:history.load",history:a})}else try{await g(),await S();let a=e.getHistory();await t.webview.postMessage({type:"db:history.load",history:a})}catch(a){this.output.appendLine(`Error loading file on webview:ready: ${a}`)}return}if((i==null?void 0:i.type)==="db:edit"){this._onDidChangeCustomDocument.fire({document:e,label:i.label??"Edit",undo:async()=>{await t.webview.postMessage({type:"undo"}),this.getContent(e).then(a=>{e.updateData(a),c=a})},redo:async()=>{await t.webview.postMessage({type:"redo"}),this.getContent(e).then(a=>{e.updateData(a),c=a})}}),this.getContent(e).then(a=>{e.updateData(a),c=a,this.output.appendLine(`Synced document state: ${a.byteLength} bytes`)}).catch(a=>{this.output.appendLine(`Sync failed: ${a}`)});return}if((i==null?void 0:i.type)==="webview:refresh"){this.output.appendLine("webview:refresh"),g().then(()=>S());return}if((i==null?void 0:i.type)==="request:save"){o.commands.executeCommand("workbench.action.files.save");return}if((i==null?void 0:i.type)==="db:content"){if(typeof i.requestId=="number"&&i.data){let a=N(i.data);a&&this.resolveContent(i.requestId,a)}return}if((i==null?void 0:i.type)!=="db:save"){if((i==null?void 0:i.type)==="export:file"){let a=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",f=typeof i.text=="string"?i.text:"";if(!f){t.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}let d=b.extname(a).replace(".","")||"txt",h=b.dirname(e.uri.fsPath),l=o.Uri.file(b.join(h,a));(async()=>{let u=await o.window.showSaveDialog({defaultUri:l,filters:{[d.toUpperCase()]:[d]}});if(!u){t.webview.postMessage({type:"export:result",ok:!1,message:"Save canceled."});return}await o.workspace.fs.writeFile(u,Buffer.from(f,"utf8")),t.webview.postMessage({type:"export:result",ok:!0,message:`Saved ${b.basename(u.fsPath)}`})})().catch(u=>{let M=u instanceof Error?u.message:String(u);t.webview.postMessage({type:"export:result",ok:!1,message:M})});return}if((i==null?void 0:i.type)==="export:save"){let a=typeof i.name=="string"&&i.name.trim()?i.name.trim():"export.txt",f=typeof i.text=="string"?i.text:"";if(!f){t.webview.postMessage({type:"export:result",ok:!1,message:"Nothing to save."});return}let d=b.dirname(e.uri.fsPath),h=b.join(d,a);o.workspace.fs.writeFile(o.Uri.file(h),Buffer.from(f,"utf8")).then(()=>{this.output.appendLine(`saved export: ${h}`),t.webview.postMessage({type:"export:result",ok:!0,message:`Saved to ${h}`})},l=>{let u=l instanceof Error?l.message:String(l);t.webview.postMessage({type:"export:result",ok:!1,message:u})});return}if((i==null?void 0:i.type)==="webview:log"){i.message&&this.output.appendLine(`webview log: ${i.message}`);return}if((i==null?void 0:i.type)==="webview:error"){let a=[i.message?`message=${i.message}`:void 0,i.source?`source=${i.source}`:void 0,i.line?`line=${i.line}`:void 0,i.column?`column=${i.column}`:void 0].filter(Boolean).join(" ");this.output.appendLine(`webview error: ${a}`),i.stack&&this.output.appendLine(String(i.stack))}}}),await g(),t.webview.html=O(t.webview,this.extensionUri),s&&await S()}resolveContent(e,t){let n=this.pendingContentResolves.get(e);n&&(n(t),this.pendingContentResolves.delete(e))}async getContent(e){let t=this.webviews.get(e.uri.toString());if(!t)throw new Error("No panel found for document");let n=++this._requestIdPool,s=new Promise((c,p)=>{this.pendingContentResolves.set(n,c),setTimeout(()=>{this.pendingContentResolves.has(n)&&(this.pendingContentResolves.delete(n),p(new Error("Timeout waiting for content")))},5e3)});return await t.webview.postMessage({type:"do-get-content",saveId:n}),s}async saveCustomDocument(e,t){try{let n;try{n=await this.getContent(e),e.updateData(n)}catch(c){let p=e.getData();if(p)n=p;else throw c}await o.workspace.fs.writeFile(e.uri,n);let s=this.webviews.get(e.uri.toString());s&&(s.webview.postMessage({type:"db:save:result",ok:!0,message:"Saved"}),s.webview.postMessage({type:"db:saved"}))}catch(n){throw this.output.appendLine(`Save failed: ${n}`),n}}async saveCustomDocumentAs(e,t,n){try{let s;try{s=await this.getContent(e),e.updateData(s)}catch(c){let p=e.getData();if(p)s=p;else throw c}await o.workspace.fs.writeFile(t,s)}catch(s){throw this.output.appendLine(`Save As failed: ${s}`),s}}async revertCustomDocument(e,t){e.clearHistory();let n=this.webviews.get(e.uri.toString());n&&await n.webview.postMessage({type:"webview:refresh"})}isUint8Array(e){var t;return e instanceof Uint8Array||!!e&&typeof e=="object"&&((t=e.constructor)==null?void 0:t.name)==="Uint8Array"}async saveHistoryToUri(e,t){try{let n=e.getHistory(),s=JSON.stringify(n,(p,w)=>w instanceof Uint8Array?{$type:"blob",data:Array.from(w)}:this.isUint8Array(w)?{$type:"blob",data:Array.from(w)}:w),c=new TextEncoder().encode(s);await o.workspace.fs.writeFile(t,c),this.output.appendLine(`[Extension] History saved to ${t.fsPath}`)}catch(n){this.output.appendLine(`[Extension] Failed to save history: ${n}`)}}async backupCustomDocument(e,t,n){let s;try{s=await this.getContent(e),e.updateData(s)}catch(p){let w=e.getData();if(w)this.output.appendLine("Using cached data for backup"),s=w;else throw p}await o.workspace.fs.writeFile(t.destination,s);let c=t.destination.with({path:t.destination.path+".history.json"});return await this.saveHistoryToUri(e,c),{id:t.destination.toString(),delete:()=>{try{o.workspace.fs.delete(t.destination),o.workspace.fs.delete(c)}catch{}}}}},D=new Set;async function U(r,e){if(!_(r))return;let t=r.toString();if(!D.has(t)){D.add(t),setTimeout(()=>D.delete(t),1500);try{await o.commands.executeCommand("vscode.openWith",r,"sqliteDbViewer.dbViewer")}catch(n){let s=n instanceof Error?n.message:String(n);e.appendLine(`openWith failed: ${s}`),o.window.showErrorMessage(`SQLite DB Viewer could not be opened: ${s}`)}}}function _(r){let e=b.extname(r.fsPath).toLowerCase();return e===".db"||e===".sqlite"||e===".sqlite3"}function O(r,e){let t=o.Uri.joinPath(e,"webview-ui","dist"),n=o.Uri.joinPath(t,"index.html"),s=A.readFileSync(n.fsPath,"utf8"),c=Date.now().toString(),p=q(),w=["default-src 'none'",`img-src ${r.cspSource} blob: data:`,`style-src ${r.cspSource} 'unsafe-inline'`,`font-src ${r.cspSource}`,`connect-src ${r.cspSource}`,`worker-src ${r.cspSource}`,`script-src 'nonce-${p}' 'wasm-unsafe-eval'`].join("; "),y=r.asWebviewUri(o.Uri.joinPath(e,"dist","codicons","codicon.css"));s=s.replace("<head>",`<head>\r
<meta http-equiv="Content-Security-Policy" content="${w}">\r
<link rel="stylesheet" href="${y}">`);let v=r.asWebviewUri(t).toString();return s=s.replace(/(href|src)="\.?\/?assets\//g,`$1="${v}/assets/`),s=s.replace(/(href|src)="\/assets\//g,`$1="${v}/assets/`),s=s.replace(/assets\/[^"']+\.(?:js|css|wasm)/g,g=>`${g}?v=${c}`),s=s.replace(/<script /g,`<script nonce="${p}" `),s}function q(){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let t=0;t<32;t+=1)e+=r.charAt(Math.floor(Math.random()*r.length));return e}function N(r){if(r instanceof Uint8Array)return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(Array.isArray(r))return Uint8Array.from(r);if(r&&typeof r=="object"){let e=r;if(e.type==="Buffer"&&Array.isArray(e.data)||Array.isArray(e.data))return Uint8Array.from(e.data);let t=Object.values(e);if(t.length&&t.every(n=>typeof n=="number"))return Uint8Array.from(t)}}
